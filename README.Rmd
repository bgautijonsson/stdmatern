---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```


# stdmatern

This directory is for development of fast and memory-efficient code that creates Mat√©rn precision matrices that have been standardized so that their inverse is a correlation matrix. The code is written in C++ and made available inside R with the `{Rcpp}` packages.

The package can be installed with 

```{r}
#| eval: false
pak::pak("bgautijonsson/stdmatern")
```



```{r}
library(stdmatern)
Q <- make_standardized_matern(dim = 2, rho = 0.5, nu = 0)
```

```{r}
Q
```

```{r}
Q |> solve()
```

Creating and standardizing a 1600x1600 precision matrix

```{r}
bench::mark(
  make_standardized_matern(dim = 40, rho = 0.5, nu = 0)
)
```


# Sampling spatial data


```{r}
#| include: false
#| echo: true
library(dplyr)
library(sparseMVN)
library(ggplot2)
```

```{r}
start <- tictoc::tic()
grid_dim <- 80
rho <- 0.9
nu <- 2
Q <- make_standardized_matern(grid_dim, rho, nu = nu)


Z <- rmvn.sparse(
    n = 1,
    mu = rep(0, nrow(Q)),
    CH = Matrix::Cholesky(Q)
)

tibble(
  Z = as.numeric(Z)
) |> 
  mutate(
    id = row_number(),
      lat = (id - 1) %% grid_dim,
      lon = cumsum(lat == 0),
    ) |> 
    ggplot(aes(lat, lon, fill = Z)) +
    geom_raster() +
    scale_fill_viridis_c() +
    coord_fixed(expand = FALSE)
stop <- tictoc::toc()
```


# Normal density

The package also implements a method for calculating the log-density of a multivariate normal by creating and scaling an appropriate precision matrix. This function is meant for use inside MCMC samplers or optimization algorithms. If you plan to use the same precision matrix often, it's better to create and store the precision matrix instead of calculating it again.

```{r}
grid_dim <- 50
rho <- 0.5
nu <- 0
x <- rnorm(grid_dim^2)
bench::mark(
  matern_mvn_density(x, grid_dim, rho, nu)
)
```

